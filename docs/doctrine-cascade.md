# Doctrine Cascade

## Overview

Overwatch generates a hierarchical chain of strategic documents that mirrors the real U.S. military planning process. Each document tier is generated by an LLM that receives the **full text of its parent authority** as prompt context, ensuring doctrinal consistency flows downward.

```mermaid
graph TD
    NDS["Tier 1: National Defense Strategy (NDS)"]
    NMS["Tier 2: National Military Strategy (NMS)"]
    JSCP["Tier 3: Joint Strategic Capabilities Plan (JSCP)"]
    CONPLAN["Tier 4: Concept Plan (CONPLAN)"]
    OPLAN["Tier 5: Operations Plan (OPLAN)"]
    JIPTL["JIPTL / JPEL"]
    MAAP["MAAP"]
    ATO["ATO / MTO / STO"]

    NDS -->|informs| NMS
    NMS -->|informs| JSCP
    JSCP -->|informs| CONPLAN
    CONPLAN -->|informs| OPLAN
    OPLAN -->|force sizing| ORBAT["Joint Force ORBAT"]
    OPLAN -->|phases| ATO
    JSCP -->|priorities| JIPTL
    JIPTL -->|targets| MAAP
    MAAP -->|sortie allocation| ATO

    style NDS fill:#1a1a2e,color:#fff
    style NMS fill:#16213e,color:#fff
    style JSCP fill:#0f3460,color:#fff
    style CONPLAN fill:#533483,color:#fff
    style OPLAN fill:#e94560,color:#fff
```

## Tier 1: National Defense Strategy (NDS)

**Model**: `flagship` (o3) — highest quality for foundational document

The NDS is the top-level strategic guidance document. It establishes national defense priorities, identifies adversary threats, and sets theater objectives.

**Prompt Context**:
- Theater of operations
- Adversary
- Scenario description

**Output**: 800–1200 word memorandum stored as `StrategyDocument` with `docType: 'NDS'`, `tier: 1`.

## Tier 2: National Military Strategy (NMS)

**Model**: `flagship`

Receives the full NDS text as context. Translates national-level guidance into military objectives, force employment priorities, and joint operational concepts.

**Stored as**: `StrategyDocument`, `docType: 'NMS'`, `tier: 2`, `parentDocId → NDS`

## Tier 3: Joint Strategic Capabilities Plan (JSCP)

**Model**: `flagship`

Receives both NDS and NMS text. Produces theater-specific tasking: force allocation, component missions, phase priorities, and operational timelines.

**Stored as**: `StrategyDocument`, `docType: 'JSCP'`, `tier: 3`, `parentDocId → NMS`

## Tier 4: Concept Plan (CONPLAN)

**Model**: `midRange` (o4-mini)

Generated by `generateCampaignPlan()`. Receives JSCP tasking to produce a concept-level plan with initial force requirements and phasing.

**Stored as**: `StrategyDocument`, `docType: 'CONPLAN'`, `tier: 4`, `parentDocId → JSCP`

## Tier 5: Operations Plan (OPLAN)

**Model**: `midRange`

The most operationally critical document. Generated from the CONPLAN with explicit instructions to include:

### FORCE_SIZING_TABLE

The OPLAN prompt instructs the LLM to embed a structured force sizing table within delimiters:

```
<!-- FORCE_SIZING_TABLE -->
[
  {
    "designation": "388 FW",
    "unitName": "388th Fighter Wing",
    "platform": "F-35A",
    "count": 24,
    "base": "Kadena AB",
    "serviceBranch": "USAF",
    "domain": "AIR",
    "role": "Air Superiority / Strike"
  }
]
<!-- /FORCE_SIZING_TABLE -->
```

This table is parsed deterministically by `generateJointForce()` to create the Blue Force ORBAT. If parsing fails, a hardcoded fallback ORBAT is used.

**Stored as**: `StrategyDocument`, `docType: 'OPLAN'`, `tier: 5`, `parentDocId → CONPLAN`

## Document Ingestion

Every generated document passes through the `ingestDocument()` service, which:

1. **Classifies** the document type (strategy/planning/order)
2. **Parses** structured content from the text
3. **Creates** the appropriate database record
4. **Logs** the ingestion in `IngestLog` with timing, confidence, and review flags

```typescript
await ingestDocument(scenarioId, rawText, {
  hierarchyLevel: 'STRATEGY',
  documentType: docType,
  sourceFormat: 'MEMORANDUM',
});
```

## Cascade Integrity

The parent-child relationship between documents is enforced via:

- `StrategyDocument.parentDocId` — each doc references its parent
- `StrategyDocument.childDocs[]` — reverse relation for browsing down the cascade
- `StrategyDocument.tier` — 1 through 5, ensuring correct ordering

This means the NDS can never be orphaned from its child NMS, and the OPLAN always traces back to the strategic rationale in the NDS.
